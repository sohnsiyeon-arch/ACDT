<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasp's Pop Quiz Time (Gemini 3.5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-white text-black min-h-screen flex flex-col items-center pt-10 px-4">

    <!-- í—¤ë” -->
    <header class="text-center mb-8">
        <div class="flex items-center justify-center gap-3 mb-2">
            <span class="text-4xl">ğŸ¤–</span>
            <h1 class="text-3xl font-bold tracking-tight">Rasp's Pop Quiz Time</h1>
        </div>
        <p class="text-xs text-blue-600 font-bold bg-blue-50 inline-block px-2 py-1 rounded">Powered by Gemini 2.5 Flash</p>
    </header>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <main class="w-full max-w-lg border-2 border-black rounded-3xl p-8 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] bg-white">
        
        <!-- [A] ì…ë ¥ í™”ë©´ -->
        <div id="input-section">
            <h2 class="text-xl font-bold text-center mb-6">Please upload your lecture notes</h2>

            <div class="mb-6">
                <label class="block text-sm font-bold mb-2">ğŸ“„ Select file (PDF or TXT)</label>
                <input type="file" id="file-input" accept=".txt, .pdf" 
                    class="block w-full text-sm text-slate-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-2 file:border-black
                    file:text-sm file:font-bold
                    file:bg-white file:text-black
                    hover:file:bg-gray-100 cursor-pointer"/>
            </div>

            <div class="flex items-center justify-center my-4 text-gray-300 font-bold">- OR -</div>

            <div class="mb-8">
                <label class="block text-sm font-bold mb-2">ğŸ“ Enter text directly</label>
                <textarea id="text-input" 
                    class="w-full h-32 p-3 border-2 border-gray-200 rounded-xl focus:border-black outline-none resize-none text-sm transition"
                    placeholder="ìˆ˜ì—… ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            </div>
            
            <button onclick="startQuizGeneration()" 
                class="w-full bg-[#D06979] hover:bg-[#b85a68] text-white font-bold text-lg py-4 rounded-2xl transition shadow-md active:scale-95">
                Create a Quiz
            </button>
        </div>

        <!-- [B] ë¡œë”© í™”ë©´ -->
        <div id="loading-section" class="hidden flex-col items-center py-10">
            <div class="animate-spin text-4xl mb-4">ğŸŒ€</div>
            <p id="loading-msg" class="font-bold text-gray-600">Reading the file...</p>
        </div>

        <!-- [C] í€´ì¦ˆ í™”ë©´ -->
        <div id="quiz-section" class="hidden">
            <div class="flex justify-between items-center mb-6 border-b-2 border-gray-100 pb-4">
                <span id="q-progress" class="font-bold text-gray-400">Q.1</span>
                <span id="score-display" class="bg-gray-100 px-3 py-1 rounded-full font-bold text-sm">0ì </span>
            </div>

            <h3 id="q-text" class="text-xl font-bold mb-8 leading-relaxed">ë¬¸ì œ ë‚´ìš©</h3>

            <div id="options-container" class="space-y-3 mb-6"></div>

            <div id="explanation-box" class="hidden bg-gray-50 border-l-4 border-[#D06979] p-4 mb-6">
                <p class="font-bold text-[#D06979] text-sm mb-1">ì •ë‹µ ë° í•´ì„¤</p>
                <p id="explanation-text" class="text-sm text-gray-700">í•´ì„¤ ë‚´ìš©</p>
            </div>

            <button id="next-btn" onclick="nextQuestion()" 
                class="hidden w-full bg-black text-white font-bold py-3 rounded-xl hover:bg-gray-800 transition">
                ë‹¤ìŒ ë¬¸ì œ ğŸ‘‰
            </button>
        </div>

        <!-- [D] ê²°ê³¼ í™”ë©´ -->
        <div id="result-section" class="hidden text-center py-6">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-2xl font-bold mb-2">í€´ì¦ˆ ë!</h2>
            <div class="text-5xl font-black text-[#D06979] mb-10">
                <span id="final-score">0</span>ì 
            </div>
            <button onclick="location.reload()" 
                class="w-full border-2 border-black font-bold py-3 rounded-xl hover:bg-gray-100 transition">
                ì²˜ìŒìœ¼ë¡œ
            </button>
        </div>
    </main>

    <script>
        
        const API_KEY = "AIzaSyDKE1Ee8gGkpMDf7RLJxjzm2eMLoePSYIY"; 
        const MODEL_NAME = "gemini-3.5-flash"; 


        let quizData = [];
        let currentIdx = 0;
        let score = 0;
        let isAnswered = false;

        async function startQuizGeneration() {
            const fileInput = document.getElementById('file-input');
            const textInput = document.getElementById('text-input').value;
            let finalContent = textInput;

            if (!API_KEY) {
                alert("ì½”ë“œ 98ë²ˆì§¸ ì¤„ì— API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');
            document.getElementById('loading-section').classList.add('flex');

            try {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.type === "application/pdf") {
                        document.getElementById('loading-msg').innerText = "PDFë¥¼ ì½ê³  ìˆì–´ìš”...";
                        const pdfText = await readPdfFile(file);
                        finalContent = pdfText + "\n" + textInput;
                    } else {
                        document.getElementById('loading-msg').innerText = "íŒŒì¼ì„ ì½ê³  ìˆì–´ìš”...";
                        const text = await readTextFile(file);
                        finalContent = text + "\n" + textInput;
                    }
                }

                if (finalContent.length < 10) {
                    alert("ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. 10ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    location.reload();
                    return;
                }

                document.getElementById('loading-msg').innerText = "AIê°€ ë¬¸ì œë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...";
                await callGeminiAPI(finalContent);

            } catch (error) {
                console.error("ìƒì„¸ ì˜¤ë¥˜:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n" + error.message);
                location.reload();
            }
        }

        async function readPdfFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(" ");
                    fullText += pageText + "\n";
                }
                return fullText;
            } catch (e) {
                throw new Error("PDF ì½ê¸° ì‹¤íŒ¨. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì•”í˜¸ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
        }

        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"));
                reader.readAsText(file);
            });
        }

        async function callGeminiAPI(content) {
            const truncatedContent = content.substring(0, 30000); // 2.5 ëª¨ë¸ì€ ì»¨í…ìŠ¤íŠ¸ê°€ ê¸¸ì–´ì„œ ë” ë§ì´ ë„£ì–´ë„ ë©ë‹ˆë‹¤
            
            const prompt = `
                ë‹¤ìŒ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ëŒ€í•™ìƒ ìˆ˜ì¤€ì˜ ê°ê´€ì‹ í€´ì¦ˆ 3ê°œë¥¼ ë§Œë“¤ì–´ì¤˜.
                í˜•ì‹ì€ ë°˜ë“œì‹œ ì•„ë˜ JSONìœ¼ë¡œë§Œ ë‹µë³€í•´. ë‹¤ë¥¸ ë§ ê¸ˆì§€.
                [{"question": "ë¬¸ì œ", "options": ["1", "2", "3", "4"], "answer": 0, "explanation": "í•´ì„¤"}]
                --- ë‚´ìš© ---
                ${truncatedContent}
            `;

            // ì„¤ì •ëœ ëª¨ë¸ ì´ë¦„(gemini-2.5-flash) ì‚¬ìš©
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();

            if (data.error) throw new Error(data.error.message);
            if (!data.candidates || data.candidates.length === 0) throw new Error("AI ì‘ë‹µ ì—†ìŒ");

            let aiText = data.candidates[0].content.parts[0].text;
            aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
            
            try {
                quizData = JSON.parse(aiText);
            } catch (e) {
                throw new Error("JSON íŒŒì‹± ì˜¤ë¥˜: AIê°€ í˜•ì‹ì„ ì§€í‚¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('flex');
            document.getElementById('quiz-section').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = quizData[currentIdx];
            isAnswered = false;
            document.getElementById('q-progress').innerText = `Q.${currentIdx + 1}/${quizData.length}`;
            document.getElementById('q-text').innerText = q.question;
            document.getElementById('explanation-box').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 text-left border-2 border-gray-200 rounded-xl hover:bg-gray-50 hover:border-black transition font-medium";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(idx, btn);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selectedIdx, btn) {
            if (isAnswered) return;
            isAnswered = true;
            const q = quizData[currentIdx];
            const allBtns = document.getElementById('options-container').children;
            if (selectedIdx === q.answer) {
                btn.classList.remove('border-gray-200');
                btn.classList.add('bg-[#D06979]', 'text-white', 'border-[#D06979]');
                score++;
            } else {
                btn.classList.add('bg-gray-200', 'text-gray-500');
                allBtns[q.answer].classList.add('border-[#D06979]', 'text-[#D06979]', 'font-bold');
            }
            document.getElementById('score-display').innerText = `${score * 10}ì `;
            document.getElementById('explanation-text').innerText = q.explanation;
            document.getElementById('explanation-box').classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
            document.getElementById('next-btn').innerText = (currentIdx === quizData.length - 1) ? "ê²°ê³¼ í™•ì¸í•˜ê¸° ğŸ†" : "ë‹¤ìŒ ë¬¸ì œ ğŸ‘‰";
        }

        function nextQuestion() {
            if (currentIdx < quizData.length - 1) {
                currentIdx++;
                renderQuestion();
            } else {
                document.getElementById('quiz-section').classList.add('hidden');
                document.getElementById('result-section').classList.remove('hidden');
                document.getElementById('final-score').innerText = score * 10;
            }
        }
    </script>
</body>
</html>

